# Letter ActivityPub Instance Management Scripts

bin/ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã¯ã€ActivityPubæ©Ÿèƒ½ã‚’ç®¡ç†ã™ã‚‹ãŸã‚ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚

## ğŸ“‹ ã‚¹ã‚¯ãƒªãƒ—ãƒˆä¸€è¦§

### ğŸš€ ã‚µãƒ¼ãƒç®¡ç†

#### `start_server.sh`
**ç”¨é€”**: ã‚µãƒ¼ãƒèµ·å‹•ï¼ˆè©³ç´°è¨ºæ–­ä»˜ãï¼‰  
**ä½¿ç”¨æ³•**: `./start_server.sh`  
**èª¬æ˜**: .envãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ç’°å¢ƒå¤‰æ•°ã‚’èª­ã¿è¾¼ã¿ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å¥å…¨æ€§ãƒã‚§ãƒƒã‚¯ã€Actor URLä¿®æ­£ã‚’å®Ÿè¡Œã—ã¦ã‹ã‚‰Railsã‚µãƒ¼ãƒã¨Solid Queueãƒ¯ãƒ¼ã‚«ãƒ¼ã‚’èµ·å‹•ã—ã¾ã™ã€‚

#### `cleanup_and_start.sh`
**ç”¨é€”**: å¼·åˆ¶ãƒªã‚»ãƒƒãƒˆï¼†å†èµ·å‹•  
**ä½¿ç”¨æ³•**: `./cleanup_and_start.sh`  
**èª¬æ˜**: å…¨ãƒ—ãƒ­ã‚»ã‚¹ã‚’å¼·åˆ¶çµ‚äº†ã—ã€è¨­å®šã‚’ä¿®æ­£ã—ã¦ã‹ã‚‰å†èµ·å‹•ã—ã¾ã™ã€‚å•é¡Œç™ºç”Ÿæ™‚ã«ä½¿ç”¨ã€‚

#### `load_env.sh`
**ç”¨é€”**: ç’°å¢ƒå¤‰æ•°èª­ã¿è¾¼ã¿ãƒ˜ãƒ«ãƒ‘ãƒ¼  
**ä½¿ç”¨æ³•**: `source bin/load_env.sh`  
**èª¬æ˜**: .envãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ç’°å¢ƒå¤‰æ•°ã‚’ç¢ºå®Ÿã«èª­ã¿è¾¼ã¿ã€Rails runnerã®ãƒ©ãƒƒãƒ‘ãƒ¼é–¢æ•°ã‚’æä¾›ã—ã¾ã™ã€‚

### ğŸ”§ è¨­å®šç®¡ç†

#### `switch_domain.sh`
**ç”¨é€”**: ãƒ‰ãƒ¡ã‚¤ãƒ³å¤‰æ›´  
**ä½¿ç”¨æ³•**: `./switch_domain.sh <æ–°ã—ã„ãƒ‰ãƒ¡ã‚¤ãƒ³> [ãƒ—ãƒ­ãƒˆã‚³ãƒ«]`  
**ä¾‹**: `./switch_domain.sh abc123.serveo.net https`  
**èª¬æ˜**: ActivityPubãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’å¤‰æ›´ã—ã€å…¨ãƒ¦ãƒ¼ã‚¶ã®URLã‚’æ›´æ–°ã—ã¾ã™ã€‚

#### `check_domain.sh`
**ç”¨é€”**: ç¾åœ¨ã®è¨­å®šç¢ºèª  
**ä½¿ç”¨æ³•**: `./check_domain.sh`  
**èª¬æ˜**: ãƒ‰ãƒ¡ã‚¤ãƒ³è¨­å®šã€ã‚µãƒ¼ãƒçŠ¶æ…‹ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹çµ±è¨ˆã€ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®å‹•ä½œã‚’ç¢ºèªã—ã¾ã™ã€‚

### ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ç®¡ç†

#### `manage_accounts.sh`
**ç”¨é€”**: ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç®¡ç†  
**ä½¿ç”¨æ³•**: `./manage_accounts.sh`  
**èª¬æ˜**: 2å€‹åˆ¶é™ã‚’è€ƒæ…®ã—ãŸã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆãƒ»å‰Šé™¤ã‚’ç®¡ç†ã€‚æ—¢å­˜ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®çŠ¶æ³ã«å¿œã˜ã¦é©åˆ‡ãªæ“ä½œã‚’æ¡ˆå†…ã—ã¾ã™ã€‚

#### `create_oauth_token.sh`
**ç”¨é€”**: OAuth ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆ  
**ä½¿ç”¨æ³•**: `./create_oauth_token.sh`  
**èª¬æ˜**: æŒ‡å®šã—ãŸãƒ¦ãƒ¼ã‚¶ç”¨ã®OAuthã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç”Ÿæˆã—ã¾ã™ã€‚APIä½¿ç”¨ã«å¿…è¦ã€‚

#### `delete_account.sh`
**ç”¨é€”**: ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤  
**ä½¿ç”¨æ³•**: `./delete_account.sh <ãƒ¦ãƒ¼ã‚¶åã¾ãŸã¯ID>`  
**ä¾‹**: `./delete_account.sh tester` ã¾ãŸã¯ `./delete_account.sh 4`  
**èª¬æ˜**: æŒ‡å®šã—ãŸã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¨ã™ã¹ã¦ã®é–¢é€£ãƒ‡ãƒ¼ã‚¿ã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¾ã™ã€‚OAuth tokensã€æŠ•ç¨¿ã€ãƒ•ã‚©ãƒ­ãƒ¼é–¢ä¿‚ã€ãƒ¡ãƒ‡ã‚£ã‚¢ãªã©ã€ã™ã¹ã¦ã®ä¾å­˜ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’é©åˆ‡ãªé †åºã§å‰Šé™¤ã—ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®æ•´åˆæ€§ã‚’ä¿ã¡ã¾ã™ã€‚

### ğŸ“ ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ

#### `create_test_posts.sh`
**ç”¨é€”**: ãƒ†ã‚¹ãƒˆæŠ•ç¨¿ç”Ÿæˆ  
**ä½¿ç”¨æ³•**: `./create_test_posts.sh`  
**èª¬æ˜**: è‹±èªã€æ—¥æœ¬èªã€æ··åœ¨ãƒ†ã‚­ã‚¹ãƒˆã®æŠ•ç¨¿ã‚’å„20ä»¶ï¼ˆè¨ˆ60ä»¶ï¼‰ç”Ÿæˆã—ã¾ã™ã€‚

### ğŸ”§ ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹

#### `fix_follow_counts.sh`
**ç”¨é€”**: ãƒ•ã‚©ãƒ­ãƒ¼ã‚«ã‚¦ãƒ³ãƒˆä¿®æ­£  
**ä½¿ç”¨æ³•**: `./fix_follow_counts.sh`  
**èª¬æ˜**: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å†…ã®ãƒ•ã‚©ãƒ­ãƒ¼ã‚«ã‚¦ãƒ³ãƒˆã‚’å®Ÿéš›ã®é–¢ä¿‚æ•°ã«åˆã‚ã›ã¦ä¿®æ­£ã—ã¾ã™ã€‚

#### `test_follow.sh`
**ç”¨é€”**: ãƒ•ã‚©ãƒ­ãƒ¼ã‚·ã‚¹ãƒ†ãƒ ãƒ†ã‚¹ãƒˆ  
**ä½¿ç”¨æ³•**: `./test_follow.sh`  
**èª¬æ˜**: ãƒ•ã‚©ãƒ­ãƒ¼ã‚·ã‚¹ãƒ†ãƒ ï¼ˆFollowServiceã€WebFingerServiceï¼‰ã®å‹•ä½œç¢ºèªã‚’è¡Œã„ã¾ã™ã€‚

#### `migrate_to_r2.sh`
**ç”¨é€”**: Cloudflare R2ç§»è¡Œ  
**ä½¿ç”¨æ³•**: `./migrate_to_r2.sh`  
**èª¬æ˜**: ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®ç”»åƒã‚’Cloudflare R2ã«ç§»è¡Œã—ã¾ã™ã€‚è¨­å®šå®Œäº†å¾Œã«ä½¿ç”¨ã€‚

## ğŸ”§ ç’°å¢ƒå¤‰æ•°ã®ç¢ºå®Ÿãªèª­ã¿è¾¼ã¿

### load_env.sh ã®ä½¿ç”¨æ–¹æ³•

ç’°å¢ƒå¤‰æ•°èª­ã¿è¾¼ã¿å•é¡Œã‚’è§£æ±ºã™ã‚‹ãŸã‚ã€`load_env.sh`ãƒ˜ãƒ«ãƒ‘ãƒ¼ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ï¼š

```bash
# ç’°å¢ƒå¤‰æ•°ã‚’èª­ã¿è¾¼ã‚“ã§ã‹ã‚‰Rails runnerã‚’å®Ÿè¡Œ
source bin/load_env.sh
run_with_env "puts Rails.application.config.activitypub.base_url"

# ã¾ãŸã¯ä¸€è¡Œã§
source bin/load_env.sh && run_with_env "your_ruby_code"
```

### ä¸»ãªæ©Ÿèƒ½
- `.env`ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºå®Ÿãªèª­ã¿è¾¼ã¿
- å¿…é ˆç’°å¢ƒå¤‰æ•°ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
- Rails runnerã®ãƒ©ãƒƒãƒ‘ãƒ¼é–¢æ•° `run_with_env()`

## ğŸ“– ä½¿ç”¨æ‰‹é †

### åˆå›ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
```bash
# 1. ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç®¡ç†
./manage_accounts.sh

# 2. OAuthãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆ
./create_oauth_token.sh

# 3. ãƒ†ã‚¹ãƒˆæŠ•ç¨¿ç”Ÿæˆï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
./create_test_posts.sh

# 4. ãƒ•ã‚©ãƒ­ãƒ¼ã‚·ã‚¹ãƒ†ãƒ ã®ãƒ†ã‚¹ãƒˆ
./test_follow.sh
```

### ã‚¢ãƒã‚¿ãƒ¼è¨­å®šï¼ˆMastodon APIæº–æ‹ ï¼‰
```bash
# APIçµŒç”±ã§ã‚¢ãƒã‚¿ãƒ¼è¨­å®šï¼ˆmultipart/form-dataï¼‰
curl -X PATCH \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -F "avatar=@/path/to/image.png" \
  "https://YOUR_DOMAIN/api/v1/accounts/update_credentials"
```

### æ—¥å¸¸é‹ç”¨
```bash
# ã‚µãƒ¼ãƒèµ·å‹•
./start_server.sh

# è¨­å®šç¢ºèª
./check_domain.sh

# ãƒ‰ãƒ¡ã‚¤ãƒ³å¤‰æ›´ï¼ˆãƒˆãƒ³ãƒãƒ«URLæœŸé™åˆ‡ã‚Œæ™‚ï¼‰
./switch_domain.sh æ–°ã—ã„ãƒ‰ãƒ¡ã‚¤ãƒ³.serveo.net https
```

### ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
```bash
# å•é¡Œç™ºç”Ÿæ™‚ã®å¼·åˆ¶ãƒªã‚»ãƒƒãƒˆ
./cleanup_and_start.sh

# é€šå¸¸èµ·å‹•ï¼ˆè©³ç´°è¨ºæ–­ä»˜ãï¼‰
./start_server.sh

# ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤ï¼ˆå•é¡Œã®ã‚ã‚‹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‰Šé™¤ï¼‰
./delete_account.sh problem_user
```

## âš™ï¸ å‰ææ¡ä»¶

- `.env` ãƒ•ã‚¡ã‚¤ãƒ«ãŒé©åˆ‡ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹ã“ã¨
- Ruby on Railsç’°å¢ƒãŒæ§‹ç¯‰ã•ã‚Œã¦ã„ã‚‹ã“ã¨
- å¿…è¦ãªgemãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã“ã¨
- jqï¼ˆJSONãƒ‘ãƒ¼ã‚µãƒ¼ï¼‰ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã“ã¨

## ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

```
bin/
â”œâ”€â”€ README.md                      # ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«
â”œâ”€â”€ load_env.sh                   # ç’°å¢ƒå¤‰æ•°èª­ã¿è¾¼ã¿ãƒ˜ãƒ«ãƒ‘ãƒ¼
â”œâ”€â”€ start_server.sh               # ã‚µãƒ¼ãƒèµ·å‹•ï¼ˆè©³ç´°è¨ºæ–­ä»˜ãï¼‰
â”œâ”€â”€ cleanup_and_start.sh          # å¼·åˆ¶ãƒªã‚»ãƒƒãƒˆï¼†å†èµ·å‹•
â”œâ”€â”€ switch_domain.sh              # ãƒ‰ãƒ¡ã‚¤ãƒ³å¤‰æ›´
â”œâ”€â”€ check_domain.sh               # è¨­å®šç¢ºèªãƒ»è¨ºæ–­
â”œâ”€â”€ manage_accounts.sh            # ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç®¡ç†ï¼ˆ2å€‹åˆ¶é™å¯¾å¿œï¼‰
â”œâ”€â”€ create_oauth_token.sh         # OAuthãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆ
â”œâ”€â”€ delete_account.sh             # ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤
â”œâ”€â”€ create_test_posts.sh          # ãƒ†ã‚¹ãƒˆæŠ•ç¨¿ç”Ÿæˆ
â”œâ”€â”€ fix_follow_counts.sh          # ãƒ•ã‚©ãƒ­ãƒ¼ã‚«ã‚¦ãƒ³ãƒˆä¿®æ­£
â”œâ”€â”€ test_follow.sh                # ãƒ•ã‚©ãƒ­ãƒ¼ã‚·ã‚¹ãƒ†ãƒ ãƒ†ã‚¹ãƒˆ
â””â”€â”€ migrate_to_r2.sh              # Cloudflare R2ç§»è¡Œ
```

## ğŸ” ã‚ˆãã‚ã‚‹å•é¡Œã¨è§£æ±ºæ–¹æ³•

### ã‚µãƒ¼ãƒãŒèµ·å‹•ã—ãªã„
```bash
./cleanup_and_start.sh
```

### ç’°å¢ƒå¤‰æ•°ãŒèª­ã¿è¾¼ã¾ã‚Œãªã„
```bash
# .envãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
cat .env

# ç’°å¢ƒå¤‰æ•°èª­ã¿è¾¼ã¿ãƒ˜ãƒ«ãƒ‘ãƒ¼ã‚’ä½¿ç”¨
source bin/load_env.sh
run_with_env "puts Rails.application.config.activitypub.base_url"

# è¨­å®šçŠ¶æ…‹ã®ç¢ºèª
./check_domain.sh
```

### ãƒ‰ãƒ¡ã‚¤ãƒ³ãŒå¤‰æ›´ã•ã‚Œãªã„
```bash
# å…¨ãƒ—ãƒ­ã‚»ã‚¹åœæ­¢å¾Œã«ãƒ‰ãƒ¡ã‚¤ãƒ³å¤‰æ›´
pkill -f "rails\|solid"
./switch_domain.sh æ–°ã—ã„ãƒ‰ãƒ¡ã‚¤ãƒ³
```

### Solid Queueãƒ—ãƒ­ã‚»ã‚¹ãŒå¤šã™ãã‚‹
```bash
./cleanup_and_start.sh
```

## ğŸ“ ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«

- `log/development.log` - Railsã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚°
- `log/solid_queue.log` - Solid Queueãƒ¯ãƒ¼ã‚«ãƒ¼ãƒ­ã‚°

## ğŸ”— é–¢é€£ã‚³ãƒãƒ³ãƒ‰

```bash
# ãƒ—ãƒ­ã‚»ã‚¹ç¢ºèª
ps aux | grep -E "rails|solid"

# ãƒ­ã‚°ç¢ºèª
tail -f log/development.log log/solid_queue.log

# ç’°å¢ƒå¤‰æ•°ç¢ºèª
source bin/load_env.sh

# API ãƒ†ã‚¹ãƒˆï¼ˆãƒˆãƒ¼ã‚¯ãƒ³ãŒå¿…è¦ï¼‰
curl -H "Authorization: Bearer YOUR_TOKEN" \
     "https://YOUR_DOMAIN/api/v1/accounts/verify_credentials"

# ãƒ•ã‚©ãƒ­ãƒ¼ã‚·ã‚¹ãƒ†ãƒ ã®ãƒ†ã‚¹ãƒˆ
source bin/load_env.sh && run_with_env "
  tester = Actor.find_by(username: 'tester', local: true)
  puts \"Base URL: #{Rails.application.config.activitypub.base_url}\"
"
```

## ğŸ“ ã‚µãƒãƒ¼ãƒˆ

å•é¡ŒãŒç™ºç”Ÿã—ãŸå ´åˆã¯ã€ã¾ãš `./check_domain.sh` ã§ç¾åœ¨ã®çŠ¶æ…‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚ãã‚Œã§ã‚‚è§£æ±ºã—ãªã„å ´åˆã¯ã€é–‹ç™ºè€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚
