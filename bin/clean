#!/bin/bash
# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å®Œå…¨ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ— & å†æ§‹ç¯‰

echo "ğŸ§¹ Database Complete Cleanup & Rebuild"
echo "======================================"

# 1. Rails ã‚µãƒ¼ãƒåœæ­¢ç¢ºèª
echo "ğŸ›‘ Stopping Rails server (if running)..."
pkill -f "rails server" 2>/dev/null || echo "No Rails server running"

# 2. æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«å®Œå…¨å‰Šé™¤
echo ""
echo "ğŸ—‘ï¸ Removing all database files..."
RAILS_ENV=${RAILS_ENV:-development}
echo "Environment: $RAILS_ENV"
rm -f storage/development.sqlite3*
rm -f storage/test.sqlite3*
rm -f storage/production.sqlite3*
rm -f storage/cable_*.sqlite3*
rm -f storage/cache.sqlite3*
rm -f storage/queue.sqlite3*
rm -f db/schema.rb
rm -f db/structure.sql

echo "âœ… Database files removed"

# 3. SQLite3ãƒ—ãƒ­ã‚»ã‚¹ç¢ºèªãƒ»çµ‚äº†
echo ""
echo "ğŸ” Checking for SQLite3 processes..."
if pgrep sqlite3 >/dev/null; then
	echo "âš ï¸ SQLite3 processes found, terminating..."
	pkill sqlite3
	sleep 1
else
	echo "âœ… No SQLite3 processes running"
fi

# 4. ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤
echo ""
echo "ğŸ§½ Cleaning temporary files..."
rm -rf tmp/cache/
rm -rf tmp/pids/
rm -rf log/*.log
echo "âœ… Temporary files cleaned"

# 5. Bundlerç’°å¢ƒã‚¯ãƒªãƒ¼ãƒ³
echo ""
echo "ğŸ’ Cleaning bundler environment..."
bundle clean --force
echo "âœ… Bundler cleaned"

# 6. Railsç’°å¢ƒåˆæœŸåŒ–
echo ""
echo "ğŸš€ Reinitializing Rails environment..."
bin/rails restart 2>/dev/null || echo "Rails restarted"

# 7. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å†ä½œæˆ
echo ""
echo "ğŸ“Š Creating fresh database..."
bin/rails db:create

# 8. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
echo ""
echo "ğŸ”„ Running migrations..."
VERBOSE=true bin/rails db:migrate

# 9. ã‚¹ã‚­ãƒ¼ãƒãƒ€ãƒ³ãƒ—
echo ""
echo "ğŸ“ Generating schema dump..."
bin/rails db:schema:dump

# 10. çµæœç¢ºèª
echo ""
echo "âœ… Verification:"
echo "Database files:"
ls -la storage/*.sqlite3* 2>/dev/null || echo "No database files yet"

echo ""
echo "Schema files:"
ls -la db/schema* db/structure* 2>/dev/null || echo "No schema files yet"

# 11. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ§‹é€ ç¢ºèª
echo ""
echo "ğŸ—„ï¸ Database structure check:"
bin/rails runner "
begin
  puts 'ğŸ“Š Tables: ' + ActiveRecord::Base.connection.tables.join(', ')
  
  # FTS5ãƒ†ãƒ¼ãƒ–ãƒ«ç¢ºèª
  fts_result = ActiveRecord::Base.connection.execute(\"SELECT name FROM sqlite_master WHERE type='table' AND sql LIKE '%fts5%'\")
  if fts_result.any?
    puts 'ğŸ” FTS5 tables: ' + fts_result.map { |row| row[0] }.join(', ')
  else
    puts 'ğŸ” FTS5 tables: None found'
  end
  
  # ãƒˆãƒªã‚¬ãƒ¼ç¢ºèª
  trigger_result = ActiveRecord::Base.connection.execute(\"SELECT name FROM sqlite_master WHERE type='trigger'\")
  puts 'âš™ï¸ Triggers: ' + trigger_result.map { |row| row[0] }.join(', ')
  
rescue => e
  puts \"âŒ Error checking database: #{e.message}\"
end
"

echo ""
echo "ğŸ¯ Cleanup and rebuild complete!"
echo ""
echo "ğŸ“‹ Next steps:"
echo "  1. Verify no errors above"
echo "  2. Test console: bin/rails console"
echo "  3. Start server: bin/rails server"
